<Project>
    <!-- If the user has not set an OutputType, then we need to set one-->
    <PropertyGroup Condition="'$(OutputType)'=='' OR '$(OutputType)'=='Library' OR '$(OutputType)'=='library'">
        <!-- It is only our responsibility to set an outputtype if the user has configured their project correctly, meaning they must have a valid beamProjectType, or have created their own OutputType to begin with.-->
        <OutputType Condition="'$(BeamProjectType)'=='storage'">Library</OutputType>
        <OutputType Condition="'$(BeamProjectType)'=='service'">Exe</OutputType>
    </PropertyGroup>

    <!-- This imports customer specific csproj files in the .beamable/temp/localDev project -->
    <Import Label="Load Beamable Local Developer Settings"
            Condition="'$(BeamProjectType)'=='storage' OR '$(BeamProjectType)'=='service'"
            Project="$(BeamableLocalDevProjectsGlob)"/>
    
    <!-- After the build completes, we should auto-generate client code to any linked projects -->
    <Target Name="generate-client" AfterTargets="Build" Condition="'$(BeamProjectType)'=='service' AND $(GenerateClientCode)==true AND $(DOTNET_RUNNING_IN_CONTAINER)!=true" Inputs="@(Compile)" Outputs="$(IntermediateOutputPath)/generateClientFlag.txt">
        <Message Text="Generating client files..." Importance="high" />
        <Exec Command="$(BeamableDotnetPath) $(BeamableTool) project generate-client $(OutDir)/$(AssemblyName).dll --output-links $(Beam_GenerateClient_Args)" EnvironmentVariables="BEAM_DOTNET_MSBUILD_PATH=$(BEAM_DOTNET_MSBUILD_PATH)"/>
        <WriteLinesToFile File="$(IntermediateOutputPath)/generateClientFlag.txt" Lines="flag" Overwrite="true"/>
    </Target>
    
    <Target Name="BeamableBuildAttrs" BeforeTargets="BeforeResGen" Condition="'$(BeamProjectType)'=='service' AND '$(BeamGenProps)'!='disable'">
        <Message Importance="high" Text="Bundling Beamable Properties..."/>
        <PropertyGroup>
            <BeamPropertiesFile>$(IntermediateOutputPath)/beamableProps.txt</BeamPropertiesFile>
        </PropertyGroup>
        <Delete Files="$(BeamPropertiesFile)"/>
        <WriteLinesToFile File="$(BeamPropertiesFile)" Overwrite="false" Lines="%(BeamableSetting.Identity)=%(BeamableSetting.Value)__BEAM__SETTING__SPLIT__"/>
        <ItemGroup>
            <EmbeddedResource Include="$(BeamPropertiesFile)" Type="Non-Resx" WithCulture="false" LogicalName="Beamable.properties"/>
        </ItemGroup>
    </Target>

<!--    <Target Name="DownloadCollectorBinaries" AfterTargets="Build" Condition="$(BeamableVersion.Contains('0.0.123'))==false">-->

<!--        <Message Importance="high" Text="Downloading collector binaries from cloud..."/>-->

<!--        <CreateProperty Value="$(BeamCollectorUrl)">-->
<!--            <Output TaskParameter="Value" PropertyName="BeamUrlBin" />-->
<!--        </CreateProperty>-->

<!--        <CreateProperty Value="$(BeamCollectorConfigUrl)">-->
<!--            <Output TaskParameter="Value" PropertyName="BeamUrlConfig" />-->
<!--        </CreateProperty>-->

<!--        <Message Importance="normal" Text="BeamUrlBin $(BeamUrlBin)"/>-->
<!--        <Message Importance="normal" Text="BeamCollectorUrl $(BeamUrlConfig)"/>-->

<!--        <PropertyGroup>-->
<!--            <BeamUrlBin>$(BeamUrlBin.Replace('BEAM_VERSION', '$(BeamableVersion)'))</BeamUrlBin>-->
<!--            <BeamUrlConfig>$(BeamUrlConfig.Replace('BEAM_VERSION', '$(BeamableVersion)'))</BeamUrlConfig>-->
<!--        </PropertyGroup>-->

<!--        <DownloadFile-->
<!--                SourceUrl="$(BeamUrlBin)"-->
<!--                DestinationFolder="$(OutputPath)">-->
<!--            <Output TaskParameter="DownloadedFile" ItemName="clickhouse-collector" />-->
<!--        </DownloadFile>-->

<!--        <DownloadFile-->
<!--                SourceUrl="$(BeamUrlConfig)"-->
<!--                DestinationFolder="$(OutputPath)">-->
<!--            <Output TaskParameter="DownloadedFile" ItemName="clickhouse-config" />-->
<!--        </DownloadFile>-->
<!--    </Target>-->

<!--    <Target Name="DownloadDebugCollectorBinaries" AfterTargets="Build" Condition="$(BeamableVersion.Contains('0.0.123'))==true">-->
<!--        <Message Importance="high" Text="[Microservice] Downloading collector binaries from local source..."/>-->

<!--        <ItemGroup>-->
<!--            <BeamDebugCollectorFile Include="$(BeamDebugCollectorUrl)">-->
<!--                <Visible>false</Visible>-->
<!--            </BeamDebugCollectorFile>-->

<!--            <AdditionaBeamDebugCollectorConfigFile Include="$(BeamDebugCollectorConfigUrl)">-->
<!--                <Visible>false</Visible>-->
<!--            </AdditionaBeamDebugCollectorConfigFile>-->
<!--        </ItemGroup>-->

<!--        <Copy SourceFiles="@(BeamDebugCollectorFile)" DestinationFolder="$(OutputPath)" SkipUnchangedFiles="true" />-->
<!--        <Copy SourceFiles="@(AdditionaBeamDebugCollectorConfigFile)" DestinationFolder="$(OutputPath)" SkipUnchangedFiles="true" />-->
<!--    </Target>-->


</Project>