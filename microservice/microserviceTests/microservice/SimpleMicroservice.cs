using Beamable.Api.Autogenerated.Accounts;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Beamable.Common;
using Beamable.Common.Api;
using Beamable.Common.Api.Auth;
using Beamable.Common.Api.Inventory;
using Beamable.Common.Api.Mail;
using Beamable.Common.Content;
using Beamable.Common.Inventory;
using Beamable.Common.Leaderboards;
using Beamable.Server;
using Beamable.Server.Content;
using NUnit.Framework;
using UnityEngine;

namespace microserviceTests.microservice
{
   [Microservice("simple", EnableEagerContentLoading = false)]
   public class SimpleMicroserviceNonLegacy : Microservice
   {
      public static MicroserviceFactory<SimpleMicroserviceNonLegacy> Factory => () => new SimpleMicroserviceNonLegacy();

      [ClientCallable]
      public string MethodWithRegularString_AsParameter(string str)
      {
         return str;
      }
   }

   [StorageObject("simple")]
   public class SimpleStorageObject : MongoStorageObject
   {

   }

   [Microservice("simple_no_updates", DisableAllBeamableEvents = true, EnableEagerContentLoading = false)]
   public class SimpleMicroserviceWithNoEvents : Microservice
   {
	   public static MicroserviceFactory<SimpleMicroserviceWithNoEvents> Factory => () => new SimpleMicroserviceWithNoEvents();


	   [ClientCallable]
	   public async Task<string> GetContent(string id)
	   {
		   var content = await Services.Content.GetContent(id);
		   return "Echo: " + content.Id;
	   }

   }
   
   public static class Ext
   {
	   public static async Promise<List<T>> GetContents<T>(this ClientManifest manifest) where T : ContentObject
	   {
		   var content = await manifest.Filter(new ContentQuery
		   {
			   TypeConstraints = new HashSet<Type>{typeof(T)}
		   }).ResolveAll();

		   return content.Cast<T>().ToList();
	   }
		
	   public async static Task<List<T>> GetContents<T>(this IBeamableServices services) where T : ContentObject, new()
	   {
		   var manifest = await services.Content.GetManifest();
		   var res = await manifest.GetContents<T>();
		   return res;
	   }
   }

   [Microservice("simple", UseLegacySerialization = true, EnableEagerContentLoading = false)]
   public class SimpleMicroservice : Microservice
   {
      public static MicroserviceFactory<SimpleMicroservice> Factory => () => new SimpleMicroservice();

      [Callable]
      public async Task FromNotNullPlease(long playerId)
      {
	      await Services.Notifications.NotifyPlayer(playerId, "test", "test");
      }
      
      [ClientCallable]
      public async Promise<List<ItemContent>> GetContents()
      {
	      var output = await Services.GetContents<ItemContent>();
	      return output;
      }
      
      [ClientCallable]
      public int Sum(int[] numbers)
      {
         if (numbers == null) return 0;

         var sum = 0;
         for (var i = 0; i < numbers.Length; i++)
         {
            sum += numbers[i];
         }

         return sum;
      }

      [ClientCallable]
      public int TwoArrays(int[] arr1, int[] arr2)
      {
         return Sum(arr1) + Sum(arr2);
      }

      [ClientCallable]
      public async Task<int> InventoryUpdateBuilderTest(InventoryUpdateBuilder builder)
      {
	      await Services.Inventory.Update(builder);
	      return 0;
      }

      [ClientCallable]
      public int Add(int a, int b)
      {
         return a + b;
      }

      [ClientCallable]
      public async Task<EmptyResponse> MethodWithSendMail()
      {
	      var mailSendRequest = new MailSendRequest();
	      var mailSendEntry = new MailSendEntry
	      {
		      category = "Test Category",
		      senderGamerTag = 123,
		      receiverGamerTag = 12345,
		      body = $"Test Body",
		      subject = "Test Subject"
	      };

	      Dictionary<string, string> ghx = new Dictionary<string, string>();
	      ghx.Add("TST1", "BLANK");
	      ghx.Add("TST2", "BLANK2");

	      var mailRewards = new MailRewards();
	      var items = new List<ItemCreateRequest>()
	      {
		      new ItemCreateRequest()
		      {
			      contentId = "WELCOME_MAIL_GIFT_LOOTBOX_SYMBOL",
			      properties = new SerializableDictionaryStringToString(ghx)
		      }
	      };

	      mailRewards.items = items;
	      mailSendEntry.rewards = mailRewards;

	      mailSendRequest.Add(mailSendEntry);
	      return await Services.Mail.SendMail(mailSendRequest);
      }

      [ClientCallable(requiredScopes: new []{"someScope"})]
      public bool AdminOnly()
      {
         return true;
      }

      [ClientCallable]
      public async Task<int> Delay(int ms)
      {
         await Task.Delay(ms);
         return ms;
      }

      [ClientCallable]
      public async Task<string> DelayThenGetEmail(int ms, long dbid)
      {
	      await Task.Delay(ms);
	      var getUser = Services.Auth.GetUser(dbid);
	      var output = await getUser;
	      return output.email;
      }

      [ClientCallable]
      public async Promise<int> PromiseTestMethod()
      {
         return await Promise<int>.Successful(1);
      }

      [ClientCallable]
      public Promise PromiseTypelessTestMethod()
      {
         Promise pr = new Promise();
         pr.CompleteSuccess();
         return pr;
      }

      [ServerCallable]
      public Promise PromiseServerTestMethod()
      {
	      var promise = new Promise();
	      promise.CompleteSuccess();
	      return promise;
      }

      [ClientCallable]
      public string MethodWithJSON_AsParameter(string jsonString)
      {
         return jsonString;
      }

      [ClientCallable]
      public string MethodWithRegularString_AsParameter(string str)
      {
         return str;
      }

      [ClientCallable]
      public Vector2Int MethodWithVector2Int_AsParameter(Vector2Int vec)
      {
         return vec;
      }
      
      [ClientCallable]
      public InventoryView MethodWithInventoryView_AsParameter(InventoryView view)
      {
	      return view;
      }

      [ClientCallable]
      public string MethodWithExceptionThrow(string msg)
      {
          throw new MicroserviceException(401, "UnauthorizedUser", "test");
      }

      // TODO: Add a test for an empty arg array, or a null

      [ClientCallable]
      public async Task<string> InventoryTest(ItemRef itemRef)
      {
         var items = await Services.Inventory.GetItems(itemRef);
         var x = items.FirstOrDefault();

         return x.ItemContent.Id;
      }

      [ClientCallable]
      public string GetVersionHeaders()
      {
	      Context.Headers.TryGetClientGameVersion(out var gameVersion);
	      Context.Headers.TryGetBeamableSdkVersion(out var sdkVersion);
	      Context.Headers.TryGetClientEngineVersion(out var engineVersion);
	      Context.Headers.TryGetClientType(out var clientType);
	      return $"h{gameVersion}/{sdkVersion}/{engineVersion}/{clientType}";
      }

      [AdminOnlyCallable]
      public async Task LeaderboardCreateTest(string boardId, LeaderboardRef templateBoardRef)
      {
         var template = await Services.Content.GetContent(templateBoardRef);
         await Services.Leaderboards.CreateLeaderboard(boardId, template);
      }

      [ClientCallable]
      public async Task LeaderboardCreateFromTemplateCallableTest(string boardId, string leaderboardContentId)
      {
         var link = new LeaderboardLink {Id = leaderboardContentId};
         var template = await link.Resolve();
         await Services.Leaderboards.CreateLeaderboard(boardId, template);
      }

      [ClientCallable]
      public async Task LeaderboardCreateFromCodeCallableTest(string boardId)
      {
         await Services.Leaderboards.CreateLeaderboard(boardId,
            new OptionalInt(),
            new OptionalLong(),
            new OptionalBoolean(),
            new OptionalCohortSettings(),
            new OptionalListString(),
            new OptionalClientPermissions{HasValue = true, Value = new ClientPermissions{writeSelf = true}},
            new OptionalLong());
      }

      [ClientCallable]
      public async Promise<int> ListLeaderboardIds()
      {
         var res = await Services.Leaderboards.ListLeaderboards();
         return res.ids.Count;
      }

      [ClientCallable]
      public async Promise<int> ListLeaderboardIdsWithSkip(int skip)
      {
         var res = await Services.Leaderboards.ListLeaderboards(skip);
         return res.ids.Count;
      }

      [ClientCallable]
      public async Promise<int> ListLeaderboardIdsWithLimit(int limit)
      {
         var res = await Services.Leaderboards.ListLeaderboards(limit:limit);
         return res.ids.Count;
      }

      [ClientCallable]
      public async Promise<int> ListLeaderboardIdsWithSkipAndLimit(int skip, int limit)
      {
         var res = await Services.Leaderboards.ListLeaderboards(skip, limit:limit);
         return res.ids.Count;
      }

      [ClientCallable]
      public async Promise<int> GetPlayerLeaderboardViews(int dbid)
      {
         var res = await Services.Leaderboards.GetPlayerLeaderboards(dbid);
         return res.lbs.Count;
      }

      [ClientCallable]
      public async Task RemovePlayerEntry(string leaderboardId, long dbid)
      {
	      await Services.Leaderboards.RemovePlayerEntry(leaderboardId, dbid);
      }

      [ClientCallable]
      public async Task<string> GetUserEmail(int dbid)
      {
         return (await Services.Auth.GetUser(dbid)).email;
      }

      [ClientCallable]
      public async Task<string> GetContent(string id)
      {
         var content = await Services.Content.GetContent(id);
         return "Echo: " + content.Id;
      }

      [ClientCallable]
      public async Task TestAssumeUser(long otherId, bool force)
      {
         var ctx = AssumeUser(otherId, force);
         await ctx.Requester.Request<EmptyResponse>(Method.GET, "x");
      }
      
      
      [ClientCallable]
      public async Task TestAssumeUser_RequestRequiresUser(long otherId, bool force)
      {
	      var ctx = AssumeUser(otherId, force);
	      
	      // the getMe call requires a user in scala-land.
	      await ctx.Provider.GetService<IAccountsApi>().GetMe();
      }

      [ClientCallable]
      public async Task<User> GetUserViaAccessToken(TokenResponse tokenResponse)
      {
         try
         {
            return await Services.Auth.GetUser(tokenResponse);
         }
         catch (Exception ex)
         {
            Assert.IsTrue(ex is NotImplementedException);
            throw;
         }
      }
      
      // WORKS
      [Callable]
      public RandomResponse Random1()
      {
	      return new RandomResponse {number = 123};
      }
		
      // WORKS
      [Callable]
      public async Task<RandomResponse> Random2()
      {
	      return await Task.FromResult(new RandomResponse {number = 123});
      }
		
      // DOES NOT WORK
      [Callable]
      public Task<RandomResponse> Random3()
      {
	      return Task.FromResult(new RandomResponse {number = 123});
      }

      // WORKS
      [Callable]
      public async Task<RandomResponse> Random4()
      {
	      return new RandomResponse {number = 123};
      }
   }
}

[Serializable]
public class RandomResponse
{
	public int number;
}
