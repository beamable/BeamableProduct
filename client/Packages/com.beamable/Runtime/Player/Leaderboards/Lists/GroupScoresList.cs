using Beamable.Api.Autogenerated.Groups;
using Beamable.Api.Autogenerated.GroupUsers;
using Beamable.Api.Autogenerated.Leaderboards;
using Beamable.Api.Autogenerated.Models;
using Beamable.Common;
using Beamable.Common.Api;
using Beamable.Coroutines;
using System;
using UnityEngine;

namespace Beamable.Player
{

	[Serializable]
	public class PlayerGroupScoresList : PlayerScoreList
	{
		private readonly IGroupsApi _groupApi;
		private readonly IGroupUsersApi _groupUserApi;

		public PlayerGroupScoresList(IPlayerLeaderboardFriend board, ILeaderboardsApi api, IUserContext ctx, CoroutineService coroutineService,IGroupsApi groupApi, IGroupUsersApi groupUserApi)
			: base(board, api, ctx, coroutineService)
		{
			_groupApi = groupApi;
			_groupUserApi = groupUserApi;
		}
		
		protected override async Promise<LeaderBoardViewResponse> CreateRequest(LeaderboardAssignmentInfo info)
		{


			try
			{
				var group = await _groupUserApi.ObjectGet(_ctx.UserId);
				Debug.Log("found group " + group.gamerTag);
				// var group = await _groupApi.ObjectGet(_ctx.UserId);

			}
			catch (Exception ex)
			{
				Debug.LogException(ex);
				throw;
			}

			// var members = group.member.
			return await _api.ObjectGetView(info.leaderboardId, guild: true, max: Size, outlier: _ctx.UserId);
			// var promiseSeq = await Promise.Sequence(
			// 	_api.ObjectGetFriends(info.leaderboardId),
			// 	_api.ObjectGetView(info.leaderboardId, max: 0, outlier: _ctx.UserId)
			// );
			//
			// var self = promiseSeq[1].lb.rankgt;
			// var friends = promiseSeq[0].lb.rankings;
			// var selfRankFound = false;
			//
			// foreach (var friend in friends)
			// {
			// 	friend.rank++; // for some reason, the server uses rank index
			// }
			//
			// if (self.HasValue)
			// {
			// 	for (var i = 0; i < friends.Length; i++)
			// 	{
			// 		if (!selfRankFound && self.Value.score > friends[i].score)
			// 		{
			// 			self.Value.rank = friends[i].rank;
			// 			selfRankFound = true;
			// 		}
			//
			// 		if (selfRankFound)
			// 		{
			// 			friends[i].rank++; // account for inserted player rank
			// 		}
			// 	}
			//
			// 	if (!selfRankFound)
			// 	{
			// 		self.Value.rank = friends.Length;
			// 	}
			// 	_board.SetCurrentFriendScore(self.Value);
			// }
			//
			// return promiseSeq[0];
		}

		public PlayerGroupScoresList LoadCount(int totalSize)
		{
			_size = totalSize;
			var _ = Refresh();
			return this;
		}

		public new async Promise<PlayerGroupScoresList> Refresh()
		{
			await base.Refresh();
			return this;
		}
	}
}
