#if UNITY_ANDROID
using Beamable;
using Beamable.Api.Autogenerated.Models;
using Beamable.Api.Autogenerated.Realms;
using Beamable.Common.Content;
using Beamable.Editor;
using Beamable.Serialization.SmallerJSON;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using UnityEditor;
using UnityEngine;

namespace Beamable.Editor.Config
{
	public class UpdateGPGSRealmConfigHelper : EditorWindow
	{
		private const string MENU_PREFIX =
			"Window/Beamable/Utilities/Third Party Integration Helpers/[Google Play Games]";
		const string WRONG_CONFIG_MESSAGE = "Install and configure Google Play Games first. Our SDK requires Google Play Games plugin installed with provided WebClientId value.";
#if BEAMABLE_GPGS
		[MenuItem(MENU_PREFIX + "Disable")]
		static void Disable()
		{
			PlayerSettingsHelper.DisableFlag("BEAMABLE_GPGS");
		}

		[MenuItem(MENU_PREFIX + "Update Realm config from web client secret file")]
		static void UpdateConfig()
		{
			var id = GetWebClientId();
			if (string.IsNullOrWhiteSpace(id))
			{
				Debug.LogError(WRONG_CONFIG_MESSAGE);
				EditorUtility.DisplayDialog("Missing config", WRONG_CONFIG_MESSAGE, "OK");
				return;
			}
			string path = EditorUtility.OpenFilePanel("Setup Google Play Games Realm config from file", "", "json");
			if (path.Length == 0) return;
			var fileContent = File.ReadAllBytes(path);
			var stringContent = System.Text.Encoding.UTF8.GetString(fileContent);
			var dict = Json.Deserialize(stringContent) as ArrayDict;
			var foundedId = dict?.JsonPath("web.client_id") as string ?? string.Empty;
			if (!foundedId.Equals(id))
			{
				var differenceText = string.IsNullOrWhiteSpace(foundedId) ? $"GPGS config ID: {id}, in provided file no id was found." : $"File ID: {foundedId}, GPGS config ID: {id}";
				Debug.LogError($"Web Client ID in file does not match the one in the config. Aborting. {differenceText}");
				EditorUtility.DisplayDialog("Wrong file", differenceText, "Abort");
				return;
			}
			var base64 = Convert.ToBase64String(fileContent);
			BeamEditorContext.Default.ServiceScope.GetService<IRealmsApi>().PostConfig(new RealmConfigChangeRequest
			{
				deletes = new OptionalArrayOfString(),
				upserts = new OptionalMapOfString(new Dictionary<string, string>
				{
					{"auth|gps_secret", base64},
				})
			}).Then(_ =>
			{
				const string message = "Realm config for Google Play Games has been updated.";
				Debug.Log(message);
				EditorUtility.DisplayDialog("Config Updated", message, "OK");
			});
		}
#else
		[MenuItem(MENU_PREFIX + "Enable")]
		static void Enable()
		{
			var id = GetWebClientId();
			if (string.IsNullOrWhiteSpace(id))
			{
				Debug.LogError(WRONG_CONFIG_MESSAGE);
				EditorUtility.DisplayDialog("Missing config", WRONG_CONFIG_MESSAGE, "OK");
				return;
			}
			PlayerSettingsHelper.EnableFlag("BEAMABLE_GPGS");
			EditorUtility.DisplayDialog("Integration enabled", "Integration is enabled.", "OK");
		}
#endif

		static string GetWebClientId()
		{
			var gameType = AppDomain.CurrentDomain.GetAssemblies().SelectMany(t => t.GetTypes())
			                        .FirstOrDefault(t => t.FullName == "GooglePlayGames.GameInfo");
			if(gameType == null)
				return string.Empty;
			var fieldInfo = gameType.GetField("WebClientId");
			if(fieldInfo == null)
				return string.Empty;
        
			return fieldInfo.GetValue(null) as string;
		}
	}
}
#endif
