using Beamable;
using Beamable.Api.Autogenerated.Models;
using Beamable.Api.Autogenerated.Realms;
using Beamable.Common.Content;
using Beamable.Serialization.SmallerJSON;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using UnityEditor;
using UnityEngine;

namespace Editor.UI.Config
{
	public class UpdateGPGSRealmConfigHelper : EditorWindow
	{
		[MenuItem("Window/Beamable/Utilities/Third Party Integration Helpers/[Google Play Games] Update Realm config from web client secret file")]
		static void UpdateConfig()
		{
			var id = GetWebClientId();
			if (string.IsNullOrWhiteSpace(id))
			{
				const string message =
					"Configure Google Play Games first. Our SDK requires Google Play Games plugin installed with provided WebClientId value.";
				Debug.LogError(message);
				EditorUtility.DisplayDialog("Missing config", message, "OK");
				return;
			}
			string path = EditorUtility.OpenFilePanel("Setup Google Play Games Realm config from file", "", "json");
			if (path.Length == 0) return;
			var fileContent = File.ReadAllBytes(path);
			var stringContent = System.Text.Encoding.UTF8.GetString(fileContent);
			var dict = Json.Deserialize(stringContent) as ArrayDict;
			var foundedId = dict?.JsonPath("web.client_id") as string ?? string.Empty;
			if (!foundedId.Equals(id))
			{
				var differenceText = string.IsNullOrWhiteSpace(foundedId) ? $"GPGS config ID: {id}, in provided file no id was found." : $"File ID: {foundedId}, GPGS config ID: {id}";
				Debug.LogError($"Web Client ID in file does not match the one in the config. Aborting. {differenceText}");
				EditorUtility.DisplayDialog("Wrong file", differenceText, "Abort");
				return;
			}
			var base64 = Convert.ToBase64String(fileContent);
			BeamEditorContext.Default.ServiceScope.GetService<IRealmsApi>().PostConfig(new RealmConfigChangeRequest
			{
				deletes = new OptionalArrayOfString(),
				upserts = new OptionalMapOfString(new Dictionary<string, string>
				{
					{"auth|gps_secret", base64},
				})
			}).Then(_ =>
			{
				const string message = "Realm config for Google Play Games has been updated.";
				Debug.Log(message);
				EditorUtility.DisplayDialog("Config Updated",message, "OK");
			});
		}

		static string GetWebClientId()
		{
			var gameType = AppDomain.CurrentDomain.GetAssemblies().SelectMany(t => t.GetTypes())
			                        .FirstOrDefault(t => t.FullName == "GooglePlayGames.GameInfo");
			if(gameType == null)
				return string.Empty;
			var fieldInfo = gameType.GetField("WebClientId");
			if(fieldInfo == null)
				return string.Empty;
        
			return fieldInfo.GetValue(null) as string;
		}
	}
}
