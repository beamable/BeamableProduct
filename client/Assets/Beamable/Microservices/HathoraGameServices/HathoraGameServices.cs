using Beamable.Api.Autogenerated.Models;
using Beamable.Common;
using Beamable.Server;
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using UnityEngine;
using Lobby = Beamable.Experimental.Api.Lobbies.Lobby;

namespace Beamable.Microservices
{
	[Microservice("HathoraGameServices")]
	public class HathoraGameServices : Microservice, IFederatedGameServer<HathoraIdentity>
	{
		// TODO: Should probably move these to a configuration file in the future
		private const string appId = "app-51bbe218-6490-4c72-abac-42903444e328";
		private const string developerToken = "ldrL6nJdkTbXSBb7mKHlEMZhIqqNmLmwuVg0Qj3doQGFs";
		// TODO: This likely needs to be configurable. Not sure where the best place to put that is.
		private const string defaultRegion = "Seattle";
		private static Uri hathoraBaseUri = new Uri("https://api.hathora.dev");

		private HttpClient http = new HttpClient
		{
			DefaultRequestHeaders = { {"Authorization", $"Bearer {developerToken}"} }
		};

		public async Promise<ServerInfo> CreateGameServer(Lobby lobby)
		{

			string roomId = lobby.lobbyId;
			ConnectionInfo response = await CreateGameServer(roomId, defaultRegion);

			while (response.status != "active")
			{
				Debug.Log($"Room {roomId} status: {response.status}");
				await Task.Delay(TimeSpan.FromSeconds(2));
				response = await GetConnectionInfo(roomId);
			}

			return new ServerInfo
			{
				globalData = new Dictionary<string, string>
				{
					{"roomId", response.roomId},
					{"host", response.exposedPort.host},
					{"name", response.exposedPort.name},
					{"port", response.exposedPort.port.ToString() },
					{"transportType", response.exposedPort.transportType}
				}
			};
		}

		private async Task<ConnectionInfo> CreateGameServer(string roomId, string region)
		{
			var createUri = new Uri(hathoraBaseUri, $"/rooms/v2/{appId}/create?roomId={roomId}") ;
			var body = new CreateRoomRequest
			{
				roomConfig = "",
				region = region
			};
			var serialized = JsonUtility.ToJson(body);
			var requestContent = new StringContent(serialized, Encoding.UTF8, "application/json");
			HttpResponseMessage response = await http.PostAsync(createUri, requestContent);
			string content = await response.Content.ReadAsStringAsync();
			Debug.Log("Create Room Hathora Response: " + content);
			if (!response.IsSuccessStatusCode)
			{
				throw new Exception(content);
			}
			return JsonUtility.FromJson<ConnectionInfo>(content);
		}

		private async Task<ConnectionInfo> GetConnectionInfo(string roomId)
		{
			var getUri = new Uri(hathoraBaseUri, $"/rooms/v2/{appId}/connectioninfo/{roomId}");
			HttpResponseMessage response = await http.GetAsync(getUri);
			string content = await response.Content.ReadAsStringAsync();
			Debug.Log("Get ConnectionInfo Hathora Response: " + content);
			if (!response.IsSuccessStatusCode)
			{
				throw new Exception(content);
			}
			return JsonUtility.FromJson<ConnectionInfo>(content);
		}
	}

	public class HathoraIdentity : IThirdPartyCloudIdentity
	{
		public string UniqueName => "hathora";
	}

	[Serializable]
	public class CreateRoomRequest
	{
		public string roomConfig;
		public string region;
	}

	[Serializable]
	public class PortInfo
	{
		public string host;
		public string name;
		public int port;
		public string transportType;
	}

	[Serializable]
	public class ConnectionInfo
	{
		public string roomId;
		public string status;
		public PortInfo exposedPort;
		public List<PortInfo> additionalExposedPorts;
	}
}
