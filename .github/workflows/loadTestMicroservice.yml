name: Perf Test Microservices

on:
  push:
    branches:
      - 'feature/beam-3376-2'

jobs:
  runPerfTest:
    timeout-minutes: 4
    runs-on: ubuntu-latest
    concurrency:
      group: stresstest-${{ github.head_ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v2
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: 6.0.x
      - name: Install Dotnet Counters
        run: |
          dotnet tool install --global dotnet-counters
      - name: Build and Install BEAM CLI 
        working-directory: ./cli/cli
        run: |
          ./install.sh
      - name: Login to BEAM CLI
        working-directory: ./stress-tests/standalone-microservice
        run: |
          beam login --username ${{ secrets.BEAM_STRESSTEST_EMAIL }} --password ${{ secrets.BEAM_STRESSTEST_PASS }} --save-to-file
      - name: Build Microservice
        working-directory: ./stress-tests/standalone-microservice/services/standalone-microservice
        run: |
          dotnet build
      - name: Build Loadtest
        working-directory: ./stress-tests/standalone-microservice/services/StressTest
        run: |
          dotnet build
      - name: Run Microservice (with profiler)
        working-directory: ./stress-tests/standalone-microservice/services/
        run: |
          cd ./standalone-microservice/bin/Debug/net6.0
          dotnet-counters collect --refresh-interval 3 --format json --output ../../../../reports/counter.json -- standalone-microservice &
          cd ../../../..
          dotnet run --project ./StressTest
          echo "jobs"
          jobs -p
          echo "kill"
          kill $(jobs -p)
      - name: Save Profiler Data 
        uses: actions/upload-artifact@v3
        with:
          name: profiler
          if-no-files-found: error
          retention-days: 15
          path: |
            ./stress-tests/standalone-microservice/services/reports
      - name: Check Dotnet Counters
        id: checkCounters
        continue-on-error: true
        working-directory: ./stress-tests/standalone-microservice/services/reports
        run: |
          beam profile check-counters ./counter.json
      - name: Check NBomber
        id: checkNbomber
        continue-on-error: true
        working-directory: ./stress-tests/standalone-microservice/services/reports
        run: |
          beam profile check-nbomber ./report.csv --p95-limit 3000
      - name: Post to a Slack channel
        if: steps.checkNbomber.outcome != 'success' || steps.checkCounters.outcome != 'success'
        id: slack
        uses: slackapi/slack-github-action@v1.21.0
        with:
          channel-id: C0409CMRKA9
          slack-message: "Automated C#MS smoke tests failed!"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
