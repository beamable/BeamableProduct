
-- Creates the traces table with materialized columns for CID and PID as primary keys
CREATE TABLE IF NOT EXISTS otel_traces ( 
    Timestamp DateTime64(9) CODEC(Delta(8), ZSTD(1)), 
    TraceId String CODEC(ZSTD(1)), 
    SpanId String CODEC(ZSTD(1)), 
    ParentSpanId String CODEC(ZSTD(1)), 
    TraceState String CODEC(ZSTD(1)), 
    SpanName LowCardinality(String) CODEC(ZSTD(1)), 
    SpanKind LowCardinality(String) CODEC(ZSTD(1)), 
    ServiceName LowCardinality(String) CODEC(ZSTD(1)), 
    ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    ScopeName String CODEC(ZSTD(1)), 
    ScopeVersion String CODEC(ZSTD(1)), 
    SpanAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    Duration UInt64 CODEC(ZSTD(1)), 
    StatusCode LowCardinality(String) CODEC(ZSTD(1)), 
    StatusMessage String CODEC(ZSTD(1)),
    Cid String MATERIALIZED ResourceAttributes['cid'],
    Pid String MATERIALIZED ResourceAttributes['pid'],
    Events Nested ( Timestamp DateTime64(9), Name LowCardinality(String), Attributes Map(LowCardinality(String), String) ) CODEC(ZSTD(1)), 
    Links Nested ( TraceId String, SpanId String, TraceState String, Attributes Map(LowCardinality(String), String) ) CODEC(ZSTD(1))
    ) 
ENGINE = MergeTree() 
PARTITION BY toDate(Timestamp) 
PRIMARY KEY (Cid, Pid)
ORDER BY (Cid, Pid, toDateTime(Timestamp))
--SETTINGS index_granularity=?, ttl_only_drop_parts = ?; 


-- Creates the logs table with materialized columns for Cid and Pid
CREATE TABLE IF NOT EXISTS otel_logs ( 
    Timestamp DateTime64(9) CODEC(Delta(8), ZSTD(1)), 
    TimestampTime DateTime DEFAULT toDateTime(Timestamp), 
    TraceId String CODEC(ZSTD(1)), 
    SpanId String CODEC(ZSTD(1)), 
    TraceFlags UInt8, 
    SeverityText LowCardinality(String) CODEC(ZSTD(1)), 
    SeverityNumber UInt8, 
    ServiceName LowCardinality(String) CODEC(ZSTD(1)), 
    Body String CODEC(ZSTD(1)), 
    ResourceSchemaUrl LowCardinality(String) CODEC(ZSTD(1)), 
    ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    ScopeSchemaUrl LowCardinality(String) CODEC(ZSTD(1)), 
    ScopeName String CODEC(ZSTD(1)), 
    ScopeVersion LowCardinality(String) CODEC(ZSTD(1)), 
    ScopeAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    LogAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
    Cid String MATERIALIZED ResourceAttributes['cid'],
    Pid String MATERIALIZED ResourceAttributes['pid'],
    )
ENGINE = MergeTree() 
PARTITION BY toDate(TimestampTime) 
PRIMARY KEY (Cid, Pid) 
ORDER BY (Cid, Pid, toDateTime(Timestamp))
--SETTINGS index_granularity=?, ttl_only_drop_parts = ?; 

-- Creates metrics otel table with materialized columns for Cid and Pid
CREATE TABLE IF NOT EXISTS otel_metrics_sum ( 
    ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    Cid String MATERIALIZED ResourceAttributes['cid'],
    Pid String MATERIALIZED ResourceAttributes['pid'],
    ResourceSchemaUrl String CODEC(ZSTD(1)), 
    ScopeName String CODEC(ZSTD(1)), 
    ScopeVersion String CODEC(ZSTD(1)), 
    ScopeAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    ScopeDroppedAttrCount UInt32 CODEC(ZSTD(1)), 
    ScopeSchemaUrl String CODEC(ZSTD(1)), 
    ServiceName LowCardinality(String) CODEC(ZSTD(1)), 
    MetricName String CODEC(ZSTD(1)), 
    MetricDescription String CODEC(ZSTD(1)), 
    MetricUnit String CODEC(ZSTD(1)), 
    Attributes Map(LowCardinality(String), String) CODEC(ZSTD(1)), 
    StartTimeUnix DateTime64(9) CODEC(Delta, ZSTD(1)), 
    TimeUnix DateTime64(9) CODEC(Delta, ZSTD(1)), 
    Value Float64 CODEC(ZSTD(1)), 
    Flags UInt32 CODEC(ZSTD(1)), 
    Exemplars Nested ( 
        FilteredAttributes Map(LowCardinality(String), String), 
        TimeUnix DateTime64(9), 
        Value Float64, 
        SpanId String, 
        TraceId String ) CODEC(ZSTD(1)), 
    AggregationTemporality Int32 CODEC(ZSTD(1)), 
    IsMonotonic Boolean CODEC(Delta, ZSTD(1))
    ) 
ENGINE = MergeTree() 
PARTITION BY toDate(TimeUnix) 
PRIMARY KEY (Cid, Pid) 
ORDER BY (Cid, Pid, toUnixTimestamp64Nano(TimeUnix)) 
--SETTINGS index_granularity=?, ttl_only_drop_parts = ?; 