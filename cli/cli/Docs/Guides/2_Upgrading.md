Update the Beamable CLI and workspaces

## Update the CLI

To install the latest version of the CLI, use the following command. 

```sh
beam version install latest
```

You can also search for available versions with the [beam version ls](doc:cli-version-ls) command. The [beam version install](doc:cli-version-install) command accepts any valid version instead of the "latest" string in the example above. 

> ðŸ“˜ .config/dotnet-tools.json
>
> As of CLI 2.1.0, Standalone Microservice Projects use dotnet local tool installations for Beamable. The version number is stored in a special dotnet file, `.config/dotnet-tools.json`. This file should be committed to version control. Please do not edit this file directly, and prefer instead to use the `beam version` command suite. 


## Migration Guide

The Beamable CLI may include changes between versions that require developer intervention. If there are known steps that a developer must perform manually, they are documented below. The following sections describe the required updates from one version to another. These are ordered with the latest versions towards the top, and the older versions toward the bottom of the document. 

### From 2.0.1 to 2.1.0

The upgrade from 2.0.1 to 2.1.0 brings a few critical updates to the `csproj` file, how the Beam CLI tool is managed, and the version of `dotnet`. 

Starting with CLI 2.1.0, you _may_ update to `net8.0`. The old `net6.0` framework will be end-of-life on November 12, 2024. 

##### CLI File Structure

You no longer need the `.beamable/local-services-manifest.json` file. You may delete it. 

More importantly, 2.1.0 changes how the CLI is installed for _new_ projects created with 2.1.0. However, nothing in 2.1.0 will _change_ your global CLI installation. We recommend you do the following steps to update the installation of the CLI. Previous to 2.1.0, the CLI was always installed globally, and all Beamable CLI projects on your computer had to share the same CLI version, or you would have had to un-install & re-install specific versions when switching projects. In 2.1.0, the CLI should be installed as a _local dotnet tool_. 

Open a terminal window to where your `.beamable` folder is located. To verify you are in the correct location, you should be able to emulate the following command, 

```sh
cat .beamable/connection-configuration.json 
{
  "host": "https://api.beamable.com",
  "cid": "857238240682",
  "pid": "DE_58923576234234"
}
```

Then, run the following command to install the CLI as a local tool.
```sh
dotnet tool install --create-manifest-if-needed beamable.tools --version 2.1.0
```

This should create a file in a top level `.config/dotnet-tools.json` with the contents, 
```json
{  
  "version": 1,  
  "isRoot": true,  
  "tools": {  
    "beamable.tools": {  
      "version": "2.1.0",  
      "commands": [  
        "beam"  
      ],  
      "rollForward": false  
    }  
  }}
```


Finally, to verify that the tool is installed locally, run the following, 
```sh
dotnet beam version
 {                                                
    "version": "2.1.0",               
    "location": "/usr/local/share/dotnet/dotnet", 
    "type": "LocalTool",                          
    "templates": "2.1.0"              
 }   
```

From now on, if you want to use the project specific CLI, run `dotnet beam` instead of `beam`. However, if you run `beam` in the context of a local project, _and_ the global version of your CLI is different than the local project version, the command will be automatically forwarded to the local version. You will see a warning message similar to this, 
```
You tried using a Beamable CLI version=[2.1.0] which is different than the one configured in this project=[2.1.0-PREVIEW.RC2]. We are forwarding the command (beam 
--pretty version) to the version the project is using via dotnet=[dotnet]. Instead of relying on this forwarding, please 'dotnet beam' from inside the project directory.
```

##### Dotnet Version

As mentioned earlier, CLI 2.1.0 adds support for `net8.0` . Given that `net6.0` will be end-of-life by the end of 2024, we recommend you update when you can. In order to update, you'll need to 
1. install the [dotnet 8 SDK](https://dotnet.microsoft.com/en-us/download/dotnet/8.0) (if you don't already have it)
2. modify the `csproj`'s `TargetFramework` value, 
3. modify the `Dockerfile` 

The `TargetFramework` modification is straight forward. Find the `TargetFramework` property each Microservice's `.csproj` file and update the value from `net6.0` to `net8.0`. 

```xml
<TargetFramework>net8.0</TargetFramework>
```

The modification to the `Dockerfile` is a bit more difficult. 

First, select the first `FROM` command in the file, and _replace_ it with the following snippet, 
```Dockerfile
FROM --platform=$BUILDPLATFORM mcr.microsoft.com/dotnet/sdk:8.0-alpine as build-env  
ARG TARGETARCH
```

Then, find the line that starts with `RUN dotnet publish`, and _replace_ the line with the following, 
```Dockerfile
RUN dotnet publish ${BEAM_CSPROJ_PATH} -p:BeamableVersion=${BEAM_VERSION} -a $TARGETARCH -c release -o /beamApp
```

##### Microservices / MicroStorages

Now that the CLI is installed as a local tool in the `.config/dotnet-tools`, Beamable attempts to treat that version number _as the only source of truth for SDK version_. Every other version reference to Beamable may be derived from that single file. New services built with CLI 2.1.0 will do this automatically, but unfortunately, existing services need to be updated manually. 

In every `csproj` file for Microservices, MicroStorages, and Common libraries, following the steps below. 

- For `csproj` files for MicroServices and MicroStorages, Ensure that the property group with a Label called `Beamable Settings` looks like this... For MicroStorage `csproj` files, the value should be `storage`. You do not need this for common libraries. 
```xml
<PropertyGroup Label="Beamable Settings">
    <!-- All Microservices must have the value, "service" -->
    <BeamProjectType>service</BeamProjectType>
</PropertyGroup>
```
- Add a property group with a Label called `Beamable Version` that looks like this:
```xml
<!-- These are special Beamable parameters that we use to keep the beamable packages in-sync to the CLI version your project is using. -->  
<!-- This makes it so your microservices are auto-updated whenever you update the CLI installed in your project. -->  
<PropertyGroup Label="Beamable Version" Condition="$(DOTNET_RUNNING_IN_CONTAINER)!=true">  
    <DotNetConfigPath Condition="'$(DotNetConfigPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove("$(MSBuildProjectDirectory)/..", ".config/dotnet-tools.json"))</DotNetConfigPath>  
    <DotNetConfig Condition="'$(DotNetConfig)' == ''">$([System.IO.File]::ReadAllText("$(DotNetConfigPath)/.config/dotnet-tools.json"))</DotNetConfig>  
    <!-- Extracts the version number from the first tool defined in 'dotnet-tools.json' that starts with "beamable". -->  
    <BeamableVersion Condition="'$(BeamableVersion)' == ''">$([System.Text.RegularExpressions.Regex]::Match("$(DotNetConfig)", "beamable.*?\"([0-9]+\.[0-9]+\.[0-9]+.*?)\",", RegexOptions.Singleline | RegexOptions.IgnorePatternWhitespace).Groups[1].Value)</BeamableVersion>  
    <!-- When running from inside docker, this gets injected via the Dockerfile at build-time. -->  
</PropertyGroup>
```

- For all `<PackageReference>` elements that reference Beamable packages, change the version string to `$(BeamableVersion)`. 
	- For Microservices and MicroStorages, this should look like the following, 
	  ```xml
<PackageReference Include="Beamable.Microservice.Runtime" Version="$(BeamableVersion)"/>
```
	- For Common Libraries, 
	  ```xml
	  <PackageReference Include="Beamable.Common" Version="$(BeamableVersion)"/>
```

If you decided to _not_ update from `net6.0` to `net8.0`, then you _must_ make a small modification to the `Dockerfile`s for Microservices. Find the `RUN dotnet publish` line and add the following property... If you followed the dotnet upgrade steps, then you should ignore this final instruction, as it was already included. 
```
-p:BeamableVersion=${BEAM_VERSION}
```
### From 1.19.22 to 2.0.1

#### CLI File Structure

The `.beamable` folder structure changes between the major versions 1, and 2. 
After you upgrade your global CLI to 2.0.1, run the following command in your project. This command should automatically perform some of the required upgrade steps.

```sh
beam config
```

If you forgot to the run the command, or would like to verify that the upgrade happened correctly, follow the bullets below.

- The `.beamable/beamoLocalManifest.json` file should no longer exist. 
- The `.beamable/beamoLocalRuntime.json` file should no longer exist.
- The `.beamable/config-defaults.json` file should no longer exist.
- The `.beamable/user-token.json` file should no longer exist. 

Instead, you should expect to see (at least), 
- `.beamable/connection-configuration.json` _(this replaces the old `config-defaults` file. )_
- `.beamable/temp/connection-auth.json` _(this replaces the old `user-token` file)_

#### `.csproj` Files

##### SDK Version

Unfortunately, the upgrade flow between major version 1 and 2 does not automatically upgrade the nuget dependency on Beamable. All of the `.csproj` files you may have will need to be manually upgraded to Beamable 2.0.1. Remember, every service, common library, and storage have their own `.csproj` files. 

Open each `csproj` file, and find the `<PackageReference>` for Beamable. 
For a service, it will likely look like this, 
```xml
<PackageReference Include="Beamable.Microservice.Runtime" Version="1.19.22" />
```

For a storage, it may (unfortunately) look like this
```xml
<PackageReference Include="Beamable.Microservice.Runtime" Version="1.15.0-PREVIEW.RC1" />
```

And for a common library, 
```xml
<PackageReference Include="Beamable.Common" Version="1.19.22" />
```

In all these cases, please update the `Version` to `2.0.1`. 

##### Structure

In addition, different project types have the following upgrade requirements...

###### Services

For services, the `csproj` file has been simplified between major versions 1 and 2. You can remove all of the tasks and extraneous nuget references. 

This snippet can (and should) be removed from a 1.19.22 service's `csproj` file.
```xml
  
<PackageReference Include="EmbedIO" Version="3.4.*" />  
<PackageReference Include="LoxSmoke.DocXml" Version="3.4.*" />  
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="6.0.0-preview.6.21352.12" />  
<PackageReference Include="Microsoft.OpenApi" Version="1.6.3" />  
<PackageReference Include="Microsoft.OpenApi.Readers" Version="1.3.2" />  
<PackageReference Include="NetMQ" Version="4.0.1.11" />  
<PackageReference Include="Newtonsoft.Json" Version="13.0.*" />  
<PackageReference Include="Serilog" Version="2.10.*" />  
<PackageReference Include="Serilog.Formatting.Compact" Version="1.1.*" />  
<PackageReference Include="Serilog.Sinks.Console" Version="3.1.*" />  
<PackageReference Include="System.CommandLine" Version="2.0.0-beta3.22114.*" />  
<PackageReference Include="System.ServiceModel.Primitives" Version="4.9.*" />  
<PackageReference Include="System.Threading.RateLimiting" Version="7.0.0" />
```

Also, all of these targets can be removed, 
```xml
  
<!-- After the build completes, we can open the local swagger page to make it easy to test endpoints -->  
<Target Name="open-swagger" AfterTargets="Build" Condition="$(OpenLocalSwaggerOnRun)==true AND $(DOTNET_RUNNING_IN_CONTAINER)!=true">  
    <Message Text="Opening local swagger docs..." Importance="high" />  
    <Exec Command="$(BeamableTool) project open-swagger $(AssemblyName)" />  
</Target>  
  
<!-- After the build completes, we should auto-generate client code to any linked projects -->  
<Target Name="generate-client" AfterTargets="Build" Condition="$(GenerateClientCode)==true AND $(DOTNET_RUNNING_IN_CONTAINER)!=true">  
    <Message Text="Generating client files..." Importance="high" />  
    <Exec Command="$(BeamableTool) project generate-client $(OutDir)/$(AssemblyName).dll --output-links" />  
</Target>  
  
<!-- Before starting the build, we need to prepare a few files and an .env file to pass startup information to the service -->  
<Target Name="setup-beamable" BeforeTargets="Build" DependsOnTargets="RunResolvePackageDependencies" Condition="$(DOTNET_RUNNING_IN_CONTAINER)!=true">  
  
    <PropertyGroup>        <BeamableVersion>@(BeamablePackage->'%(Version)')</BeamableVersion>  
    </PropertyGroup>    <!-- We need a file that lets the runtime know what version of Beamable it was built with... -->  
    <Message Text="Creating beamable version file..." Importance="high" />  
    <WriteLinesToFile File="$(OutDir)/.beamablesdkversion" Lines="$(BeamableVersion)" Overwrite="true" />  
</Target>  
  
<!-- When running in a container, before building, we need to prepare a few files -->  
<Target Name="docker-setup-beamable" BeforeTargets="Build" DependsOnTargets="RunResolvePackageDependencies" Condition="$(DOTNET_RUNNING_IN_CONTAINER)==true">  
  
    <PropertyGroup>        <BeamableVersion>@(BeamablePackage->'%(Version)')</BeamableVersion>  
    </PropertyGroup>    <Message Text="Generating files..." Importance="high" />  
    <WriteLinesToFile File="$(PublishDir)/.beamablesdkversion" Lines="$(BeamableVersion)" Overwrite="true" />  
    <WriteLinesToFile File="$(PublishDir)/.env" Lines="BEAMABLE_SDK_VERSION_EXECUTION=$(BeamableVersion)" Overwrite="true" />  
</Target>
```

The following property group section can be dramatically simplified. The only required properties from the following snippet are, 
1. `GenerateClientCode`, and 
2. `TargetFramework`

```xml
<!--  Settings for Beamable Build  -->  
<PropertyGroup>  
    <!-- The tool path for the beamCLI. "dotnet beam" will refer to the local project tool, and "beam" would install to a globally installed tool -->  
    <BeamableTool>beam</BeamableTool>  
  
    <!-- When "true", this will open a website to the local swagger page for the running service -->  
    <OpenLocalSwaggerOnRun>false</OpenLocalSwaggerOnRun>  
  
    <!-- When "true", this will auto-generate client code to any linked unity projects -->  
    <GenerateClientCode>true</GenerateClientCode>  
</PropertyGroup>  
  
<PropertyGroup Condition="$(DOTNET_RUNNING_IN_CONTAINER)!=true">  
    <DefineConstants>$(DefineConstants);BEAMABLE_GENERATE_ENV</DefineConstants>  
</PropertyGroup>  
  
<!-- Standard dotnet settings-->  
<PropertyGroup>  
    <OutputType>Exe</OutputType>  
  
    <!-- As of Beamable 1.0, net6.0 is required. -->  
    <TargetFramework>net6.0</TargetFramework>  
    <!-- Advanced C# Features are disabled by default. The Unity SDK does not support these features.   
         If you enable them, it will be harder to copy/paste code between the service and Unity. -->  
    <ImplicitUsings>disable</ImplicitUsings>  
    <Nullable>disable</Nullable>  
    <DockerDefaultTargetOS>Linux</DockerDefaultTargetOS>  
  
    <!-- Warning 1591 is about missing XML comments on methods. Beamable suggests disabling this warning.   
         https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-messages/cs1591 -->  
    <NoWarn>1591</NoWarn>  
  
    <!-- The autogenerated OpenAPI page will use the generated serviceDocs.xml file to handle   
         API descriptions. The OpenAPI page will break if there is no `serviceDocs.xml` file. -->  
    <GenerateDocumentationFile>true</GenerateDocumentationFile>  
</PropertyGroup>
```

However, there is one *new* property that is **REQUIRED**. You must add the following property, 
```xml
<BeamProjectType>service</BeamProjectType>
```

After all the edits, you should have a `csproj` file that looks similar to the following. This is the `csproj` file that is generated for a new service using CLI 2.0.1.
```xml
<Project Sdk="Microsoft.NET.Sdk">  
    <PropertyGroup Label="Beamable Settings">  
        <!-- All Microservices must have the value, "service" -->  
        <BeamProjectType>service</BeamProjectType>  
  
        <!-- When "true", this will auto-generate client code to any linked unity projects -->  
        <GenerateClientCode>true</GenerateClientCode>  
    </PropertyGroup>  
    <PropertyGroup Label="Dotnet Settings">  
        <!-- net8.0 is the LTS version until 2026. To update your net version, update the <TargetFramework> when Beamable announces support. -->  
        <TargetFramework>net6.0</TargetFramework>  
    </PropertyGroup>  
    <ItemGroup Label="Nuget References">  
        <PackageReference Include="Beamable.Microservice.Runtime" Version="2.0.1" />  
    </ItemGroup>  
</Project>
```

###### Common Libraries

Similar to services, the `csproj` file for common libraries has been simplified between major versions 1 and 2. 

You should remove this target, 
```xml
<!-- Move the built dll to the linked projects -->  
<Target Name="share-code" AfterTargets="Build" Condition="$(CopyToLinkedProjects)==true AND $(DOTNET_RUNNING_IN_CONTAINER)!=true">  
    <Message Text="Generating code for other projects" Importance="high" />  
    <Exec Command="$(BeamableTool) project share-code $(OutDir)/$(AssemblyName).dll --dep-prefix-blacklist Newtonsoft,Unity.Beamable,UnityEngine,Unity.Addressables,System" />  
</Target>
```

And from the following properties the only two that you need are, 
1. `CopyToLinkedProjects`, and
2. `TargetFramework`

```xml
  
<PropertyGroup>  
    <!-- Unity 2021 can handle netstandard2.1 libraries -->  
    <TargetFramework>netstandard2.1</TargetFramework>  
    <GenerateDocumentationFile>true</GenerateDocumentationFile>  
</PropertyGroup>  
  
<!--  Settings for Beamable Build  -->  
<PropertyGroup>  
    <!-- The tool path for the beamCLI. "dotnet beam" will refer to the local project tool, and "beam" would install to a globally installed tool -->  
    <BeamableTool>beam</BeamableTool>  
  
    <!-- When "true", this will copy the built project and associated dependencies to linked Unity projects -->  
    <CopyToLinkedProjects>true</CopyToLinkedProjects>  
</PropertyGroup>  
  
<!-- Make sure that the built dlls and their dependencies are in the output directory -->  
<PropertyGroup>  
    <ProduceReferenceAssemblyInOutDir>true</ProduceReferenceAssemblyInOutDir>  
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>  
    <PublishDocumentationFile>true</PublishDocumentationFile>  
</PropertyGroup>
```

When you are done with these edits, your `csproj` file should appear similar to the following snippet. Here is the `csproj` file for a common library created with CLI 2.0.1.
```xml
<Project Sdk="Microsoft.NET.Sdk">  
  
    <PropertyGroup Label="Dotnet Settings">  
        <TargetFramework>netstandard2.1</TargetFramework>  
    </PropertyGroup>  
    <PropertyGroup Label="Beamable Settings">  
        <!-- When "true", this will copy the built project and associated dependencies to linked Unity projects -->  
        <CopyToLinkedProjects>true</CopyToLinkedProjects>  
    </PropertyGroup>    <ItemGroup Label="Nuget References">  
        <PackageReference Include="Beamable.Common" Version="2.0.1" />  
    </ItemGroup></Project>
```


#### Dockerfiles

Any service you created in 1.19.22 will have a `Dockerfile`. These files need some manual edits to make them compatible with 2.0.1. 

Select all the lines _between_ the first `FROM` command, and the `RUN dotnet publish` command, and _replace_ them with the following.

```Dockerfile  
# <BEAM-CLI-COPY-ENV> this line signals the start of environment variables copies into the built container. Do not remove it. This will be overwritten every time a variable changes in the execution of the CLI.  
  
# </BEAM-CLI-COPY-ENV> this line signals the end of environment variables copies into the built container. Do not remove it.  
  
# <BEAM-CLI-COPY-SRC> this line signals the start of Beamable Project Src copies into the built container. Do not remove it. The content between here and the closing tag will change anytime the Beam CLI modifies dependencies.  
  
# </BEAM-CLI-COPY-SRC> this line signals the end of Beamable Project Src copies. Do not remove it.  
  
# build the dotnet program  
WORKDIR /
```

Next, select the lines starting with (and _including_) `RUN dotnet publish` until the line (but not including) `ENTRYPOINT` , and _replace_ them with the following, 
```Dockerfile
RUN dotnet publish ${BEAM_CSPROJ_PATH} -c release -o /beamApp  
  
# use the dotnet runtime as the final stage  
FROM mcr.microsoft.com/dotnet/runtime:6.0-alpine  
WORKDIR /beamApp  
  
# expose the health port  
EXPOSE 6565   
# copy the built program  
COPY --from=build-env /beamApp .
```

Finally, on the last line (the `ENTRYPOINT`), replace the `/subapp` with `/beamApp`

Here is a Dockerfile that was adapted from 2.0.1. There are two important things to note, 
1. this file is for a service called `Example3`, which justifies the `ENTRYPOINT`, and
2. when you run `beam services run`, the CLI will _inject_ content into the file based on the `BEAM-CLI-` tags. After the command runs, you should see `ENV`, `RUN`, and `COPY` statements between the beamable tags. This is how the `${BEAM_CSPROJ_PATH}` reference will be resolved. 

```Dockerfile
# use the dotnet sdk as a build stage  
FROM mcr.microsoft.com/dotnet/sdk:6.0-alpine as build-env  
  
# <BEAM-CLI-COPY-ENV> this line signals the start of environment variables copies into the built container. Do not remove it. This will be overwritten every time a variable changes in the execution of the CLI.  
  
# </BEAM-CLI-COPY-ENV> this line signals the end of environment variables copies into the built container. Do not remove it.  
  
# <BEAM-CLI-COPY-SRC> this line signals the start of Beamable Project Src copies into the built container. Do not remove it. The content between here and the closing tag will change anytime the Beam CLI modifies dependencies.  
  
# </BEAM-CLI-COPY-SRC> this line signals the end of Beamable Project Src copies. Do not remove it.  
  
# build the dotnet program  
WORKDIR /  
  
RUN dotnet publish ${BEAM_CSPROJ_PATH} -c release -o /beamApp  
  
# use the dotnet runtime as the final stage  
FROM mcr.microsoft.com/dotnet/runtime:6.0-alpine  
WORKDIR /beamApp  
  
# expose the health port  
EXPOSE 6565   
# copy the built program  
COPY --from=build-env /beamApp .  
  
# when starting the container, run dotnet with the built dll  
ENTRYPOINT ["dotnet", "/beamApp/Example3.dll"]  
```

#### Microservice .config folders

Finally, the `.config` folder under each Microservice folder should be deleted. This file is cruft, and is no longer needed. 

Also, remember that if your Microservice is referencing a Storage object, you must have Docker running; otherwise the Microservice will not start correctly.  