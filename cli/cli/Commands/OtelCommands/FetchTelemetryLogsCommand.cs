using Beamable.Api.Autogenerated.Models;
using Beamable.Common.BeamCli.Contracts;
using Beamable.Server;
using cli.Services;
using Spectre.Console;
using System.CommandLine;
using System.Text.RegularExpressions;

namespace cli.OtelCommands;

[Serializable]
public class FetchTelemetryLogsCommandArgs : CommandArgs
{
	public string ServiceName;
	public string LogLevel;
	public int LimitRows;
	public string BodyMatch;
	public bool FullMatch;
	public string FromTime;
	public bool AscendingOrder;
}

public class FetchTelemetryLogsResult
{
	public List<FetchCommandLogRecord> allLogsFound;
}

public class FetchCommandLogRecord
{
	public string Timestamp;
	public string LogLevel;
	public string ServiceName;
	public string Message;
	public Dictionary<string, string> LogAttributes;

	public string RenderMessage()
	{
		return Regex.Replace(
			Message,
			@"\{([^}]+)\}",
			match =>
			{
				var key = match.Groups[1].Value.Trim();

				if (LogAttributes != null && LogAttributes.TryGetValue(key, out var value) && value != null)
				{
					return value.ToString();
				}

				// no attribute â†’ keep original "{key}"
				return match.Value;
			});
	}
}

public class FetchTelemetryLogsCommand : AtomicCommand<FetchTelemetryLogsCommandArgs, FetchTelemetryLogsResult>, ISkipManifest
{
	public FetchTelemetryLogsCommand() : base("logs", "Fetch logs from Clickhouse")
	{
	}

	public override void Configure()
	{
		AddArgument(new Argument<string>("filter", () => string.Empty, "Value to be matched with the log message body"){Arity = ArgumentArity.ZeroOrOne}, (args, i) => args.BodyMatch = i);
		AddOption(new Option<string>("--id", "Filter logs by doing a full match with the service name"),
			(args, i) => args.ServiceName = i);
		AddOption(new Option<string>("--log-level", "Filter logs by doing a full match with the Log Level. Available values are: [\"Trace\", \"Debug\", \"Information\", \"Warning\", \"Error\", \"Critical\", \"None\"]"),
			(args, i) => args.LogLevel = i);
		AddOption(new Option<int>("--limit", () => 100, "Sets a max number of rows to be retrieved by this command"),
			(args, i) => args.LimitRows = i);
		AddOption(new Option<bool>("--full-match", "If set, this will make the body message match be a full exact match"),
			(args, i) => args.FullMatch = i);
		AddOption(new Option<string>("--from", "The amount of time to go back and retrieve logs. Examples: 12d (12 days), 5m (5 minutes), 48h (48 hours)"),
			(args, i) => args.FromTime = i);
		AddOption(new Option<bool>(new string[]{"--ascending", "--asc"}, () => false,"If set, this will force the order to be ascending instead of the default descending order"),
			(args, i) => args.AscendingOrder = i);
	}

	public override bool AutoLogOutput => false;

	public override async Task<FetchTelemetryLogsResult> GetResult(FetchTelemetryLogsCommandArgs args)
	{
		OtelAuthConfig config;
		if (!ClickhouseConnection.GetClickhouseAuthOverrides(out config))
		{
			config = await args.OtelApi.GetOtelAuthReaderConfig();
		}

		var result = await ClickhouseConnection.FetchLogs(config, args);

		var columnNameStyle = new Style(Color.SlateBlue1);

		var table = new Table();
		var timestampCol = new TableColumn(new Markup("Timestamp", columnNameStyle));
		var logLevelCol = new TableColumn(new Markup("Log Level", columnNameStyle));
		var serviceCol = new TableColumn(new Markup("Service Id", columnNameStyle));
		var messageCol = new TableColumn(new Markup("Message", columnNameStyle));

		table.AddColumn(timestampCol).AddColumn(logLevelCol).AddColumn(serviceCol).AddColumn(messageCol);
		foreach (var log in result)
		{
			var timestampMarkup = new Markup($"{log.Timestamp}");
			var logLevelMarkup = new Markup($"{log.LogLevel}");
			var serviceMarkup = new Markup($"{log.ServiceName}");
			var messageMarkup = new Markup($"{Markup.Escape(log.RenderMessage())}");

			table.AddRow(new TableRow(new[] { timestampMarkup, logLevelMarkup, serviceMarkup, messageMarkup}));
		}
		AnsiConsole.Write(table);

		return new FetchTelemetryLogsResult()
		{
			allLogsFound = result
		};
	}
}
