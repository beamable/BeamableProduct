using Beamable.Api.Autogenerated.Models;
using Beamable.Common.Dependencies;
using Beamable.Server;
using cli.OtelCommands.Grafana;
using cli.Services;
using cli.Utils;
using ClickHouse.Client.Utility;
using CliWrap;

namespace cli.OtelCommands;
using Otel = Beamable.Common.Constants.Features.Otel;

public class StartGrafanaCommandArgs : CommandArgs
{
    
}

public class StartGrafanaCommandResults
{
    
}

public class StartGrafanaCommand : AtomicCommand<StartGrafanaCommandArgs, StartGrafanaCommandResults>
{
    public StartGrafanaCommand() : base("open", "Opens a local Grafana installation to inspect telemetry data ")
    {
    }

    public override void Configure()
    {
    }

    public override async Task<StartGrafanaCommandResults> GetResult(StartGrafanaCommandArgs args)
    {
	    var env = await GetClickhouseConnectionStrings(args);
        
        await StartGrafanaContainer(args.DependencyProvider, env);

        return new StartGrafanaCommandResults();
    }

    
    public static async Task StartGrafanaContainer(
        IDependencyProvider provider, 
        ClickhouseConnectionStrings connection)
    {
        var app = provider.GetService<IAppContext>();

        var wasRunning = await GrafanaCommand.IsGrafanaRunning(app);
        if (wasRunning)
        {
            MachineHelper.OpenBrowser(GrafanaCommand.GetGrafanaUrl(app));
            return;
        }

        string proviosingPath = $"{GrafanaCommand.GetAbsoluteFilePath_ProvisioningFolder()}:/etc/grafana/provisioning";
        string grafanaIniPath = $"{GrafanaCommand.GetAbsoluteFilePath_GrafanaIni()}:/etc/grafana/grafana.ini";
        string dashboardPath = $"{GrafanaCommand.GetAbsoluteFilePath_DefaultDashboard()}:/etc/grafana/default-dashboard.json";
        
        var argString = $"run -d --rm " +
                        $"--name={GrafanaCommand.GetGrafanaContainerName(app)} " +
                        $"-p 127.0.0.1:{GrafanaCommand.GetGrafanaPort(app)}:3000 " +
                        $"-e GF_SECURITY_ADMIN_USER=beamable " +
                        $"-e GF_SECURITY_ADMIN_PASSWORD=beamable " +
                        $"-e BEAM_CLICKHOUSE_ENDPOINT={connection.Endpoint} " +
                        $"-e BEAM_CLICKHOUSE_USERNAME={connection.UserName} " +
                        $"-e BEAM_CLICKHOUSE_PASSWORD={connection.Password} " +
                        $"-e BEAM_CLICKHOUSE_HOST={connection.Host} " +
                        $"-e BEAM_CLICKHOUSE_PORT={connection.Port} " +
                        $"-e GF_INSTALL_PLUGINS=grafana-clickhouse-datasource " +
                        $"-v {proviosingPath.QuoteDouble()} " + 
                        $"-v {grafanaIniPath.QuoteDouble()} " +
                        $"-v {dashboardPath.QuoteDouble()} " +
                        $"-v {GrafanaCommand.GetGrafanaVolumeName(app)}:/var/lib/grafana " +
                        $"grafana/grafana:11.6.1";
        
        var command = Cli
            .Wrap(app.DockerPath)
            .WithArguments(argString)
            .WithValidation(CommandResultValidation.None)
            .WithStandardOutputPipe(PipeTarget.ToDelegate(line =>
            {
                Log.Debug($"Started Grafana container id=[{line}]");
            }))
            .WithStandardErrorPipe(PipeTarget.ToDelegate(line =>
            {
                Log.Error(line);
            }));
		      
        var result = await command.ExecuteAsync();

        var isRunning = await GrafanaCommand.ReadGrafanaLogs(app);
        if (isRunning)
        {
            MachineHelper.OpenBrowser(GrafanaCommand.GetGrafanaUrl(app));
        }
        // get the logs and wait for the magic number... 
    }

    private static async Task<ClickhouseConnectionStrings> GetClickhouseConnectionStrings(StartGrafanaCommandArgs args)
    {
	    string endpoint;
	    string userName;
	    string passd;

	    if (!ClickhouseConnection.GetClickhouseAuthOverrides(out var config))
	    {
		    OtelAuthConfig res = await args.OtelApi.GetOtelAuthReaderConfig();
		    endpoint = res.endpoint;
		    userName = res.username;
		    passd = res.password;
	    }
	    else
	    {
		    endpoint = config.endpoint;
		    userName = config.username;
		    passd = config.password;
	    }

	    string uriString = endpoint;
	    if (!endpoint.StartsWith("http://", StringComparison.OrdinalIgnoreCase) &&
	        !endpoint.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
	    {
		    uriString = "http://" + endpoint;
	    }

	    var uri = new Uri(uriString);

	    var host = uri.Host;
	    var port = uri.Port.ToString();

	    return new ClickhouseConnectionStrings() { Host = host, Port = port, UserName = userName, Password = passd, Endpoint = endpoint};
    }
}
