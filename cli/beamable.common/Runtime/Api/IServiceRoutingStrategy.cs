using Beamable.Api.Autogenerated.Beamo;
using Beamable.Api.Autogenerated.Models;
using System;
using System.Collections.Generic;
using System.Linq;

namespace Beamable.Common.Api
{
	public interface IServiceRoutingStrategy
	{
		/// <summary>
		/// All services must have a routing key in the format,
		/// name:key
		/// and multiple keys can be separated with commas. 
		/// </summary>
		/// <returns></returns>
		Promise<Dictionary<string, string>> GetServiceMap();
	}

	public static class ServiceRoutingStrategyExtensions
	{
		/// <summary>
		/// Uses the <see cref="IServiceRoutingStrategy.GetServiceMap"/> method to produce a
		/// well formatted string for the routing key header value.
		/// </summary>
		/// <param name="strategy"></param>
		/// <returns></returns>
		public static async Promise<string> GetRoutingHeaderValue(this IServiceRoutingStrategy strategy)
		{
			var map = await strategy.GetServiceMap();
			var value = string.Join(",", map.Select(kvp => $"{kvp.Key}:{kvp.Value}"));
			return value;
		}

		public static string GetDefaultRoutingKeyForMachine()
		{
			return Environment.MachineName
				.Replace(":", "_")
				.Replace(",", "_")
				.ToLowerInvariant();
		}
	}
	
	
	public class DefaultServiceRoutingStrategy : IServiceRoutingStrategy
	{
		private IBeamoApi _beamo;

		public DefaultServiceRoutingStrategy(IBeamoApi beamo)
		{
			_beamo = beamo;
		}

		/// <summary>
		/// The routing key should be the machine name of the host.
		/// The routing keys do not allow : and , characters, because those
		/// characters are used as delimiters 
		/// </summary>
		public static string DefaultRoutingKey => ServiceRoutingStrategyExtensions.GetDefaultRoutingKeyForMachine();
		
		public async Promise<Dictionary<string, string>> GetServiceMap()
		{
			var res = await _beamo.PostMicroserviceRegistrations(new MicroserviceRegistrationsQuery(), includeAuthHeader: true);

			var results = new Dictionary<string, string>();

			// extract all services that have a matching routing key
			foreach (var reg in res.registrations)
			{
				if (reg.routingKey?.TryGet(out var routingKey) ?? false)
				{
					if (string.Equals(routingKey, DefaultRoutingKey))
					{
						// extract the service name, which is in the format cid.pid.name.basic, 
						var serviceName = reg.serviceName.Split('.')[2];
						results[serviceName] = routingKey;
					}
				} 
			}

			return results;
		}
	}
}
