using Beamable;
using System;
using Beamable.Common.Content;
using System.Collections.Generic;
using Beamable.Api.Autogenerated.Models;
using Beamable.Common;
using Beamable.Common.Dependencies;
using Beamable.Server;
using Beamable.Tooling.Common.OpenAPI;
using cli;
using cli.Unreal;
using Microsoft.Extensions.Logging;
using Microsoft.OpenApi;
using Microsoft.OpenApi.Extensions;
using Microsoft.OpenApi.Models;
using NUnit.Framework;
using System.Linq;
using System.Threading.Tasks;
using tests;
using Unity.Beamable.Customer.Common;
using UnityEngine;
using ZLogger;

namespace Unity.Beamable.Customer.Common
{
	[Serializable]
	public class ItemReward
	{
		public string contentID;
		public long instanceID = 0;
		public long amount = 0;
		public Dictionary<string, string> properties;
	}
    
	[Serializable] 
	public class ListSubtype<T> : List<T> { }
	
	[Serializable]
	public class DictSubtype<TKey, TValue> : Dictionary<TKey, TValue> { }

	[Serializable]
	public class ContentObjectSubType : ContentObject { }
	
	[Serializable]
	public class SerializedClass {}
	
	[Serializable]
	public struct SerializedStruct {}
	
	public class NonSerializedClass {}
	
	public struct NonSerializedStruct {}

	
	[Serializable]
	public class ValidClass_NonBeamGenerate
	{
		public InvalidClass_MissingBeamGenerate MissingBeamGenerate;
		public InvalidClass_MissingSerializable MissingSerializable;
		public InvalidClass_MissingBeamGenerateAndSerializable MissingBeamGenerateAndSerializable;
		public InvalidEnum_MissingSerializable EnumMissingSerializable;
	}
	
	[Serializable, BeamGenerateSchema]
	public class ValidClass_BeamGenerate
	{
		public InvalidClass_MissingBeamGenerate MissingBeamGenerate;
		public InvalidClass_MissingSerializable MissingSerializable;
		public InvalidClass_MissingBeamGenerateAndSerializable MissingBeamGenerateAndSerializable;
		public InvalidEnum_MissingSerializable EnumMissingSerializable;
	}
	
	[BeamGenerateSchema]
	public class InvalidClass_MissingSerializable {}
	
	[Serializable]
	public class InvalidClass_MissingBeamGenerate {}
	
	public class InvalidClass_MissingBeamGenerateAndSerializable {}
	
	public enum InvalidEnum_MissingSerializable { None = 0}

	[Serializable]
	public class ValidClass_WarningProperties
	{
		public int Count { get; set; }
	}
	
	[Serializable]
	public class ValidClass_InvalidFields
	{
		private ListSubtype<string> _listSubtype;
		private DictSubtype<string, string> _dictSubtype;
		private Dictionary<int, string> _invalidDict;
		private ContentObject _contentObject;
		private ContentObjectSubType _contentObjectSubType;
	}
}
namespace Beamable.SourceGenTest
{
	/// <summary>
	/// this class is not meant to be used. It's sole purpose is to stand in
	/// when something in the outer class needs to access a method with nameof() 
	/// </summary>
	[FederationId("dummyThirdParty")]
	class DummyThirdParty : IFederationId
	{
		public string UniqueName => "__temp__";
	}
	[Microservice("SourceGenTest")]
	public partial class SourceGenTest : Microservice, IFederatedLogin<DummyThirdParty>, IFederatedPlayerInit<DummyThirdParty>, IFederatedGameServer<DummyThirdParty>
	{
		private static string StaticStringValue = "Hello World";
		
		[ClientCallable]
		public short Test_ReturnType_Short()
		{
			return short.MaxValue;
		}
		
		[ClientCallable]
		public int Test_ReturnType_Int()
		{
			return int.MaxValue;
		}

		[ClientCallable]
		public long Test_ReturnType_Long()
		{
			return long.MaxValue;
		}

		[ClientCallable]
		public float Test_ReturnType_Float()
		{
			return float.MaxValue;
		}

		[ClientCallable]
		public double Test_ReturnType_Double()
		{
			return double.MaxValue;
		}

		[ClientCallable]
		public char Test_ReturnType_Char()
		{
			return 'A';
		}

		[ClientCallable]
		public string Test_ReturnType_String()
		{
			return "TestString";
		}

		[ClientCallable]
		public byte Test_ReturnType_Byte()
		{
			return byte.MaxValue;
		}

		[ClientCallable]
		public uint Test_ReturnType_UInt()
		{
			return uint.MaxValue;
		}

		[ClientCallable]
		public sbyte Test_ReturnType_SByte()
		{
			return sbyte.MaxValue;
		}

		[ClientCallable]
		public ulong Test_ReturnType_ULong()
		{
			return ulong.MaxValue;
		}

		[ClientCallable]
		public ushort Test_ReturnType_UShort()
		{
			return ushort.MaxValue;
		}

		[ClientCallable]
		public DateTime Test_ReturnType_DateTime()
		{
			return DateTime.Now;
		}

		[ClientCallable]
		public Guid Test_ReturnType_Guid()
		{
			return Guid.NewGuid();
		}
		
		[ClientCallable]
		public async Task<short> Test_ReturnType_Short_Async()
		{
			await Task.Delay(1);
			return short.MaxValue;
		}
		
		[ClientCallable]
		public async Task<int> Test_ReturnType_Int_Async()
		{
			await Task.Delay(1);
			return int.MaxValue;
		}

		[ClientCallable]
		public async Task<long> Test_ReturnType_Long_Async()
		{
			await Task.Delay(1);
			return long.MaxValue;
		}

		[ClientCallable]
		public async Task<float> Test_ReturnType_Float_Async()
		{
			await Task.Delay(1);
			return float.MaxValue;
		}

		[ClientCallable]
		public async Task<double> Test_ReturnType_Double_Async()
		{
			await Task.Delay(1);
			return double.MaxValue;
		}

		[ClientCallable]
		public async Task<char> Test_ReturnType_Char_Async()
		{
			await Task.Delay(1);
			return 'A';
		}

		[ClientCallable]
		public async Task<string> Test_ReturnType_String_Async()
		{
			await Task.Delay(1);
			return "TestString";
		}

		[ClientCallable]
		public async Task<byte> Test_ReturnType_Byte_Async()
		{
			await Task.Delay(1);
			return byte.MaxValue;
		}

		[ClientCallable]
		public async Task<uint> Test_ReturnType_UInt_Async()
		{
			await Task.Delay(1);
			return uint.MaxValue;
		}

		[ClientCallable]
		public async Task<sbyte> Test_ReturnType_SByte_Async()
		{
			await Task.Delay(1);
			return sbyte.MaxValue;
		}

		[ClientCallable]
		public async Task<ulong> Test_ReturnType_ULong_Async()
		{
			await Task.Delay(1);
			return ulong.MaxValue;
		}

		[ClientCallable]
		public async Task<ushort> Test_ReturnType_UShort_Async()
		{
			await Task.Delay(1);
			return ushort.MaxValue;
		}

		[ClientCallable]
		public async Task<DateTime> Test_ReturnType_DateTime_Async()
		{
			await Task.Delay(1);
			return DateTime.Now;
		}

		[ClientCallable]
		public async Task<Guid> Test_ReturnType_Guid_Async()
		{
			await Task.Delay(1);
			return Guid.NewGuid();
		}

		[ClientCallable]
		public ItemReward[] Test_ReturnType_ItemRewardArray()
		{
			return new ItemReward[]{};
		}

		[ClientCallable]
		public List<ItemReward> Test_ReturnType_ItemRewardList()
		{
			return new List<ItemReward>(); 
		}

		[ClientCallable]
		public async Task<ItemReward[]> Test_ReturnType_ItemRewardArray_Async()
		{
			await Task.Delay(1);
			return Array.Empty<ItemReward>();
		}

		[ClientCallable]
		public async Task<List<ItemReward>> Test_ReturnType_ItemRewardList_Async()
		{
			await Task.Delay(1);
			return new List<ItemReward>();
		}

		
		[ClientCallable]
		public ContentObject Test_ReturnType_ContentObject()
		{
			return ScriptableObject.CreateInstance<ContentObject>();
		}

		[ClientCallable]
		public ContentObject[] Test_ReturnType_ContentObjectArray()
		{
			return new ContentObject[]{};
		}

		[ClientCallable]
		public List<ContentObject> Test_ReturnType_ContentObjectList_Error()
		{
			return new List<ContentObject>();
		}

		[ClientCallable]
		public async Task<ContentObject> Test_ReturnType_ContentObject_Async_Error()
		{
			await Task.Delay(1);
			return ScriptableObject.CreateInstance<ContentObject>();
		}

		[ClientCallable]
		public async Task<ContentObject[]> Test_ReturnType_ContentObjectArray_Async()
		{
			await Task.Delay(1);
			return new ContentObject[]{};
		}

		[ClientCallable]
		public async Task<List<ContentObject>> Test_ReturnType_ContentObjectList_Async_Error()
		{
			await Task.Delay(1);
			return new List<ContentObject>();
		}
		
		[ClientCallable]
		public ContentRef<ContentObject> Test_ReturnType_ContentRef()
		{
			return new ContentRef<ContentObject>(); 
		}

		[ClientCallable]
		public ContentRef<ContentObject>[] Test_ReturnType_ContentRefArray()
		{
			return new ContentRef<ContentObject>[]{}; 
		}

		[ClientCallable]
		public List<ContentRef<ContentObject>> Test_ReturnType_ContentRefList()
		{
			return new List<ContentRef<ContentObject>>(); 
		}

		[ClientCallable]
		public async Task<ContentRef<ContentObject>> Test_ReturnType_ContentRef_Async()
		{
			await Task.Delay(1);
			return new ContentRef<ContentObject>();
		}

		[ClientCallable]
		public async Task<ContentRef<ContentObject>[]> Test_ReturnType_ContentRefArray_Async()
		{
			await Task.Delay(1);
			return new ContentRef<ContentObject>[]{}; 
		}

		[ClientCallable]
		public async Task<List<ContentRef<ContentObject>>> Test_ReturnType_ContentRefList_Async()
		{
			await Task.Delay(1);
			return new List<ContentRef<ContentObject>>();
		}

		[ClientCallable]
		public ContentObjectSubType Test_ReturnType_ContentObjectSubType_Error()
		{
			return ScriptableObject.CreateInstance<ContentObjectSubType>();
		}

		[ClientCallable]
		public ContentObjectSubType[] Test_ReturnType_ContentObjectSubTypeArray_Error()
		{
			return new ContentObjectSubType[]{}; 
		}

		[ClientCallable]
		public List<ContentObjectSubType> Test_ReturnType_ContentObjectSubTypeList_Error()
		{
			return new List<ContentObjectSubType>();
		}

		[ClientCallable]
		public async Task<ContentObjectSubType> Test_ReturnType_ContentObjectSubType_Async_Error()
		{
			await Task.Delay(1);
			return ScriptableObject.CreateInstance<ContentObjectSubType>();
		}

		[ClientCallable]
		public async Task<ContentObjectSubType[]> Test_ReturnType_ContentObjectSubTypeArray_Async_Error()
		{
			await Task.Delay(1);
			return new ContentObjectSubType[]{}; 
		}

		[ClientCallable]
		public async Task<List<ContentObjectSubType>> Test_ReturnType_ContentObjectSubTypeList_Async_Error()
		{
			await Task.Delay(1);
			return new List<ContentObjectSubType>();
		}
		
		[ClientCallable]
		public Dictionary<string, int> Test_ReturnType_DictionaryStringInt()
		{
			return new Dictionary<string, int>();
		}

		[ClientCallable]
		public Dictionary<int, int> Test_ReturnType_DictionaryIntInt_Error()
		{
			return new Dictionary<int, int>();
		}

		[ClientCallable]
		public DictSubtype<string, string> Test_ReturnType_DictSubtypeStringString_Error()
		{
			return new DictSubtype<string, string>();
		}

		[ClientCallable]
		public async Task<Dictionary<string, int>> Test_ReturnType_DictionaryStringInt_Async_Error()
		{
			await Task.Delay(1);
			return new Dictionary<string, int>();
		}

		[ClientCallable]
		public async Task<Dictionary<int, int>> Test_ReturnType_DictionaryIntInt_Async_Error()
		{
			await Task.Delay(1);
			return new Dictionary<int, int>();
		}

		[ClientCallable]
		public async Task<DictSubtype<string, string>> Test_ReturnType_DictSubtypeStringString_Async_Error()
		{
			await Task.Delay(1);
			return new DictSubtype<string, string>();
		}

		[ClientCallable]
		public ListSubtype<string> Test_ReturnType_ListSubtypeString_Error()
		{
			return new ListSubtype<string>();
		}

		[ClientCallable]
		public async Task<ListSubtype<string>> Test_ReturnType_ListSubtypeString_Async_Error()
		{
			await Task.Delay(1);
			return new ListSubtype<string>();
		}

		[ClientCallable]
		public SerializedClass Test_ReturnType_SerializedClass()
		{
			return new SerializedClass();
		}

		[ClientCallable]
		public async Task<SerializedClass> Test_ReturnType_SerializedClass_Async()
		{
			await Task.Delay(1);
			return new SerializedClass();
		}

		[ClientCallable]
		public SerializedStruct Test_ReturnType_SerializedStruct()
		{
			return default;
		}

		[ClientCallable]
		public async Task<SerializedStruct> Test_ReturnType_SerializedStruct_Async()
		{
			await Task.Delay(1);
			return default;
		}

		[ClientCallable]
		public NonSerializedClass Test_ReturnType_NonSerializedClass_Error()
		{
			return new NonSerializedClass();
		}

		[ClientCallable]
		public async Task<NonSerializedClass> Test_ReturnType_NonSerializedClass_Async_Error()
		{
			await Task.Delay(1);
			return new NonSerializedClass();
		}

		[ClientCallable]
		public NonSerializedStruct Test_ReturnType_NonSerializedStruct_Error()
		{
			return default;
		}

		[ClientCallable]
		public async Task<NonSerializedStruct> Test_ReturnType_NonSerializedStruct_Async_Error()
		{
			await Task.Delay(1);
			return default;
		}
		
		[ClientCallable]
		public void Test_Param_Short(short value) { }

		[ClientCallable]
		public void Test_Param_Int(int value) { }

		[ClientCallable]
		public void Test_Param_Long(long value) { }

		[ClientCallable]
		public void Test_Param_Float(float value) { }

		[ClientCallable]
		public void Test_Param_Double(double value) { }

		[ClientCallable]
		public void Test_Param_Char(char value) { }

		[ClientCallable]
		public void Test_Param_String(string value) { }

		[ClientCallable]
		public void Test_Param_Byte(byte value) { }

		[ClientCallable]
		public void Test_Param_SByte(sbyte value) { }

		[ClientCallable]
		public void Test_Param_UInt(uint value) { }

		[ClientCallable]
		public void Test_Param_ULong(ulong value) { }

		[ClientCallable]
		public void Test_Param_UShort(ushort value) { }
		
		[ClientCallable]
		public void Test_Param_DateTime(DateTime value) { }

		[ClientCallable]
		public void Test_Param_Guid(Guid value) { }
		
		[ClientCallable]
		public void Test_Param_ItemReward(ItemReward value) { }

		[ClientCallable]
		public void Test_Param_ItemRewardArray(ItemReward[] value) { }

		[ClientCallable]
		public void Test_Param_ItemRewardList(List<ItemReward> value) { }
		
		[ClientCallable]
		public void Test_Param_ContentObject_Error(ContentObject value) { }

		[ClientCallable]
		public void Test_Param_ContentRef(ContentRef<ContentObject> value) { }

		[ClientCallable]
		public void Test_Param_ContentObjectSubType_Error(ContentObjectSubType value) { }
		
		[ClientCallable]
		public void Test_Param_DictionaryStringInt(Dictionary<string, int> value) { }

		[ClientCallable]
		public void Test_Param_DictionaryIntInt_Error(Dictionary<int, int> value) { }

		[ClientCallable]
		public void Test_Param_DictSubtypeStringString_Error(DictSubtype<string, string> value) { }
		
		[ClientCallable]
		public void Test_Param_ListSubtypeString_Error(ListSubtype<string> value) { }
		
		[ClientCallable]
		public void Test_Param_SerializedClass(SerializedClass value) { }

		[ClientCallable]
		public void Test_Param_SerializedStruct(SerializedStruct value) { }
		
		[ClientCallable]
		public void Test_Param_NonSerializedClass_Error(NonSerializedClass value) { }

		[ClientCallable]
		public void Test_Param_NonSerializedStruct_Error(NonSerializedStruct value) { }
		
		[ClientCallable]
		public void Test_InvalidFieldsInClass(ValidClass_NonBeamGenerate value) { }
		
		[ClientCallable]
		public void Test_ClassWithProperties(ValidClass_WarningProperties value) { }
		
		[ClientCallable]
		public void Test_ClassWithInvalidFields(ValidClass_InvalidFields value) { }

		public Promise<FederatedAuthenticationResponse> Authenticate(string token, string challenge, string solution)
		{
			throw new NotImplementedException();
		}

		public async Promise<PlayerInitResult> CreatePlayer(Account account, Dictionary<string, string> properties)
		{
			return new PlayerInitResult();
		}

		public async Promise<ServerInfo> CreateGameServer(Lobby lobby)
		{
			return new ServerInfo();
		}

		[ServerCallable]
		public async Task CreateMatchResult(long userId, string lobbyId)
		{
		}
		
		[Test]
		public void TestUnreal2MicroserviceGen()
		{
			BeamableZLoggerProvider.Provider = new BeamableZLoggerProvider();
			BeamableZLoggerProvider.LogContext.Value = LoggerFactory.Create(builder =>
			{
				builder.AddZLoggerConsole();
			}).CreateLogger<Tests>();
		
			var gen = new ServiceDocGenerator();
		
			var builder = new DependencyBuilder();
		
			builder.AddSingleton<BeamStandardTelemetryAttributeProvider>();
			builder.AddSingleton<SingletonDependencyList<ITelemetryAttributeProvider>>();
			builder.AddSingleton<IMicroserviceArgs>(new MicroserviceArgs());
			var provider = builder.Build();
			var doc = gen.Generate<SourceGenTest>(provider);
			string json = doc.SerializeAsJson(OpenApiSpecVersion.OpenApi3_0);

			Console.WriteLine(json);
			UnrealSourceGenerator.exportMacro = "TROUBLESOMEPROJECT_API";
			UnrealSourceGenerator.blueprintExportMacro = "TROUBLESOMEPROJECTBLUEPRINTNODES_API";
			UnrealSourceGenerator.headerFileOutputPath = "/";
			UnrealSourceGenerator.cppFileOutputPath = "/";
			UnrealSourceGenerator.blueprintHeaderFileOutputPath = "/Public/";
			UnrealSourceGenerator.blueprintCppFileOutputPath = "/Private/";
			UnrealSourceGenerator.genType = UnrealSourceGenerator.GenerationType.Microservice;
			var generator = new UnrealSourceGenerator();
			var docs = new List<OpenApiDocument>() { doc };
			var orderedSchemas = SwaggerService.ExtractAllSchemas(docs,
				GenerateSdkConflictResolutionStrategy.RenameUncommonConflicts);
			var ctx = new SwaggerService.DefaultGenerationContext
			{
				Documents = docs,
				OrderedSchemas = orderedSchemas,
				ReplacementTypes = new Dictionary<OpenApiReferenceId, ReplacementTypeInfo>()
			};
			var descriptors = generator.Generate(ctx);

			Console.WriteLine("----- OUTPUT ----");
			Console.WriteLine(string.Join("\n", descriptors.Select(d => $"{d.FileName}\n\n{d.Content}\n")));
			Console.WriteLine($"Descriptor counts: {descriptors.Count}");
			// Assert.AreEqual(15, descriptors.Count);
		}
	}
	
}
