<html>
    <head>

    </head>
    <style>
        button {
            /* we can influence the styles of the dynamic component */
            color: red;
        }
    </style>
    <body>
        <script lang="javascript">

            // https://stackoverflow.com/questions/1197575/can-scripts-be-inserted-with-innerhtml
            function nodeScriptReplace(node) {
                if ( nodeScriptIs(node) === true ) {
                        node.parentNode.replaceChild( nodeScriptClone(node) , node );
                }
                else {
                        var i = -1, children = node.childNodes;
                        while ( ++i < children.length ) {
                            nodeScriptReplace( children[i] );
                        }
                }

                return node;
            }
            function nodeScriptClone(node){
                    var script  = document.createElement("script");
                    script.text = node.innerHTML;

                    var i = -1, attrs = node.attributes, attr;
                    while ( ++i < attrs.length ) {                                    
                        script.setAttribute( (attr = attrs[i]).name, attr.value );
                    }
                    return script;
            }

            function nodeScriptIs(node) {
                    return node.tagName === 'SCRIPT';
            }

            // theoretically, this would be dynamically fetched by talking to Beamo to get a list of services, and then talking to each service for a list of endpoints that apply to a given mount site.
           
            // step 0. talk to beamo to get a list of user services...

            // step 1. fetch the view manifest from the service.

            var tuna = 2;

            (async function() { 

                var viewManifestRoute = 'admin/GetViewManifest'
                var serviceName = 'AuthTesting';
                var cid = '1323424830305280';
                var pid = 'DE_1409075572900864';
                var prefix = 'AB410E05-D720-5576-B3B9-98EE4A496322';
                var auth = 'bf32f8ab-97d9-4c13-b5dc-91a32269bddf';
                var baseUrl = `https://dev.api.beamable.com/basic/${cid}.${pid}.${prefix}micro_${serviceName}`;
                var viewManifestUrl = `${baseUrl}/${viewManifestRoute}`;
            
                var manifest = await (await fetch(viewManifestUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth}`,
                        'X-DE-SCOPE': `${cid}.${pid}`
                    }
                })).json();
                console.log(manifest);

                // var componentUrl = `${baseUrl}/${manifest.Views[1].Path}`;

                loadMicrofrontEnd('#mountSite1', manifest.Views[0])
                loadMicrofrontEnd('#mountSite2', manifest.Views[1])
                async function loadMicrofrontEnd(domSelector, view) {
                    var componentUrl = `${baseUrl}/${view.Path}`
                    console.log('loading', componentUrl)
                    var source = await (await fetch(componentUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth}`,
                        'X-DE-SCOPE': `${cid}.${pid}`
                    }
                })).json();
                // console.log(source);

                const scriptElement = document.createElement("script");
                var mountSite = document.querySelector(domSelector);

                const wrapperScript = document.createElement("script");
                wrapperScript.src = URL.createObjectURL(new Blob([source], { type: 'text/javascript' }));

                var tuna = 1;
                document.head.appendChild(wrapperScript);

                // wait for the component to load.
                setTimeout( () => {
                    // console.log(widget);
                    mountSite.innerHTML = ''; // clear
                    window[view.AppName](mountSite);
                }, 0)
                }
                

                // TODO: There is an issue, that scripts could be intentional malicious in a marketplace scenario. We'd want to make sure that a microfront-end CANNOT access anything beyond its own scope. http://jsfiddle.net/agoywobt/ this becomes a classic javascript security game of whack-ah-mole. 
            })();
        </script>
        <script>
            // var tuna = 3;
        </script>

        <div>
            <div>
                The grey element is injected
            </div>
            <div style="background-color: lightgrey; 
                        box-shadow: 0px 0px 12px 4px rgba(0,0,0,.3);
                        padding: 12px;
                        margin: 12px;">
                <div id="mountSite1">Loading...</div>
            </div>
            <div>
                And now we are back on the main page
            </div>
        </div>
        <div>
            <div>
                The grey element is injected
            </div>
            <div style="background-color: lightgrey; 
                        box-shadow: 0px 0px 12px 4px rgba(0,0,0,.3);
                        padding: 12px;
                        margin: 12px;">
                <div id="mountSite2">Loading...</div>
            </div>
            <div>
                And now we are back on the main page
            </div>
        </div>
    </body>
</html>